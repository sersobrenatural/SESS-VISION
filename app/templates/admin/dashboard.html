{% extends "base.html" %}

{% block title %}Dashboard - Admin SESS-Vision{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>Panel de AdministraciÃ³n</h1>
            <p>Bienvenido, {{ admin_nombre }}</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('main.admin_solicitudes') }}" class="btn btn-primary">
                Ver Todas las Solicitudes
            </a>
            <a href="{{ url_for('main.admin_logout') }}" class="btn btn-secondary">
                Cerrar SesiÃ³n
            </a>
        </div>
    </div>

    <!-- EstadÃ­sticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ðŸ“Š</div>
            <div class="stat-content">
                <h3>Total Solicitudes</h3>
                <div class="stat-number" id="total-solicitudes">{{ estadisticas.total }}</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ðŸ“¨</div>
            <div class="stat-content">
                <h3>No LeÃ­das</h3>
                <div class="stat-number" id="no-leidas">{{ estadisticas.no_leidas }}</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
                <h3>Contactados</h3>
                <div class="stat-number" id="contactados">{{ estadisticas.por_estado.get('contactado', 0) }}</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ðŸ“…</div>
            <div class="stat-content">
                <h3>Este Mes</h3>
                <div class="stat-number" id="este-mes">{{ estadisticas.ultimos_7_dias | length }}</div>
            </div>
        </div>
    </div>

    <!-- DistribuciÃ³n por Servicio -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3>Solicitudes por Servicio</h3>
            <div class="chart-container">
                <canvas id="serviciosChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3>Solicitudes por Estado</h3>
            <div class="chart-container">
                <canvas id="estadosChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Solicitudes Recientes -->
    <div class="recent-requests">
        <div class="section-header">
            <h3>Solicitudes Recientes</h3>
            <a href="{{ url_for('main.admin_solicitudes') }}" class="btn btn-outline">Ver Todas</a>
        </div>
        
        {% if solicitudes_recientes %}
        <div class="requests-list">
            {% for solicitud in solicitudes_recientes %}
            <div class="request-item {% if not solicitud.leido %}unread{% endif %}" data-id="{{ solicitud.id }}">
                <div class="request-header">
                    <div class="request-info">
                        <h4>{{ solicitud.nombre }}</h4>
                        <span class="request-service">{{ solicitud.servicio }}</span>
                    </div>
                    <div class="request-meta">
                        <span class="request-date">{{ solicitud.fecha }}</span>
                        <span class="request-priority priority-{{ solicitud.prioridad }}">
                            {% if solicitud.prioridad == 3 %}Alta
                            {% elif solicitud.prioridad == 2 %}Media
                            {% else %}Baja{% endif %}
                        </span>
                    </div>
                </div>
                <div class="request-body">
                    <p class="request-message">{{ solicitud.mensaje[:100] }}{% if solicitud.mensaje|length > 100 %}...{% endif %}</p>
                </div>
                <div class="request-actions">
                    {% if not solicitud.leido %}
                    <button class="btn btn-sm btn-primary mark-read-btn" data-id="{{ solicitud.id }}">
                        Marcar LeÃ­da
                    </button>
                    {% endif %}
                    <a href="{{ url_for('main.admin_solicitudes') }}?id={{ solicitud.id }}" class="btn btn-sm btn-outline">
                        Ver Detalles
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">ðŸ“­</div>
            <h4>No hay solicitudes recientes</h4>
            <p>Las nuevas solicitudes aparecerÃ¡n aquÃ­.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Datos para grÃ¡ficos en elementos data-* -->
<div id="chart-data" 
     data-servicios='{{ estadisticas.por_servicio | tojson | safe }}'
     data-estados='{{ estadisticas.por_estado | tojson | safe }}'
     style="display: none;">
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Obtener datos desde elementos HTML
function getChartData() {
    const chartDataElement = document.getElementById('chart-data');
    
    try {
        const serviciosData = JSON.parse(chartDataElement.getAttribute('data-servicios'));
        const estadosData = JSON.parse(chartDataElement.getAttribute('data-estados'));
        
        return { serviciosData, estadosData };
    } catch (error) {
        console.error('Error parsing chart data:', error);
        return { serviciosData: {}, estadosData: {} };
    }
}

// Inicializar grÃ¡ficos
function initializeCharts() {
    const { serviciosData, estadosData } = getChartData();
    
    // GrÃ¡fico de servicios
    const serviciosCtx = document.getElementById('serviciosChart');
    if (serviciosCtx) {
        new Chart(serviciosCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(serviciosData),
                datasets: [{
                    data: Object.values(serviciosData),
                    backgroundColor: ['#0066cc', '#00d4aa', '#ff6b6b', '#ffd93d', '#6c5ce7']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // GrÃ¡fico de estados
    const estadosCtx = document.getElementById('estadosChart');
    if (estadosCtx) {
        new Chart(estadosCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: Object.keys(estadosData),
                datasets: [{
                    label: 'Solicitudes',
                    data: Object.values(estadosData),
                    backgroundColor: '#0066cc'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Manejar botones de marcar como leÃ­do
function setupMarkAsReadButtons() {
    document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const solicitudId = this.getAttribute('data-id');
            
            try {
                const response = await fetch(`/api/admin/marcar_leido/${solicitudId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.closest('.request-item').classList.remove('unread');
                    this.remove();
                    // Actualizar contadores
                    document.getElementById('no-leidas').textContent = 
                        parseInt(document.getElementById('no-leidas').textContent) - 1;
                } else {
                    alert('Error al marcar como leÃ­do');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexiÃ³n');
            }
        });
    });
}

// Inicializar cuando el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupMarkAsReadButtons();
});
</script>
{% endblock %}